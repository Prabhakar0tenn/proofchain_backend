require("dotenv").config();

const express = require("express");
const cors = require("cors");
const algosdk = require("algosdk");
const mongoose = require("mongoose");
const generateHash = require("./utils/hash");
const Certificate = require("./models/Certificate");

console.log("ðŸš€ Server starting...");

const app = express();
app.use(cors());
app.use(express.json());

/* =============================
   ENV VALIDATION
============================= */
if (!process.env.MNEMONIC || !process.env.MONGO_URI) {
  console.error("âŒ Missing environment variables");
  process.exit(1);
}

console.log("âœ… ENV Loaded");

/* =============================
   MongoDB Connection
============================= */
mongoose.connect(process.env.MONGO_URI)
  .then(() => console.log("âœ… MongoDB Connected"))
  .catch(err => {
    console.error("âŒ MongoDB Error:", err.message);
    process.exit(1);
  });

/* =============================
   ALGOD CLIENT (Testnet)
============================= */
const algodClient = new algosdk.Algodv2(
  "",
  "https://testnet-api.algonode.cloud",
  ""
);

/* =============================
   CREATOR ACCOUNT
============================= */
let creatorAccount;

try {
  creatorAccount = algosdk.mnemonicToSecretKey(process.env.MNEMONIC);
  console.log("âœ… Creator Address:", creatorAccount.addr.toString());
} catch (err) {
  console.error("âŒ Failed to decode mnemonic");
  process.exit(1);
}

/* =============================
   HELPER: Wait for Confirmation
============================= */
async function waitForConfirmation(client, txId) {
  const status = await client.status().do();
  let lastRound = status["last-round"];

  while (true) {
    const pendingInfo = await client.pendingTransactionInformation(txId).do();

    if (pendingInfo["confirmed-round"] && pendingInfo["confirmed-round"] > 0) {
      return pendingInfo;
    }

    lastRound++;
    await client.statusAfterBlock(lastRound).do();
  }
}

/* =============================
   MINT CERTIFICATE
============================= */
app.post("/mint", async (req, res) => {
  try {
    const { studentName, course } = req.body;

    if (!studentName || !course) {
      return res.status(400).json({
        success: false,
        message: "Student name and course required"
      });
    }

    console.log("ðŸ”¥ Mint request received");

    // Generate Certificate Hash
    const certificateHash = generateHash(studentName, course);

    // Blockchain params
    const params = await algodClient.getTransactionParams().do();

    const txn = algosdk.makeAssetCreateTxnWithSuggestedParamsFromObject({
      sender: creatorAccount.addr,
      total: 1,
      decimals: 0,
      assetName: "ProofChain Certificate",
      unitName: "CERT",
      assetURL: `https://proofchain.app/cert/${certificateHash}`,
      suggestedParams: params,
    });

    // Sign transaction
    const signedTxn = txn.signTxn(creatorAccount.sk);

    // Send transaction
    const { txId } = await algodClient
      .sendRawTransaction(signedTxn)
      .do();

    console.log("ðŸ“¡ Transaction sent:", txId);

    // Wait for confirmation
    await waitForConfirmation(algodClient, txId);

    console.log("âœ… Transaction confirmed:", txId);

    // Save in MongoDB
    const newCertificate = await Certificate.create({
      studentName,
      course,
      certificateHash,
      txId
    });

    return res.json({
      success: true,
      txId,
      certificateHash
    });

  } catch (err) {
    console.error("âŒ Mint Error:", err.message);

    return res.status(500).json({
      success: false,
      error: err.message
    });
  }
});

/* =============================
   VERIFY CERTIFICATE
============================= */
app.get("/verify/:hash", async (req, res) => {
  try {
    const cert = await Certificate.findOne({
      certificateHash: req.params.hash
    });

    if (!cert) {
      return res.status(404).json({
        success: false,
        message: "Certificate not found"
      });
    }

    return res.json({
      success: true,
      certificate: cert
    });

  } catch (err) {
    console.error("âŒ Verify Error:", err.message);

    return res.status(500).json({
      success: false,
      error: err.message
    });
  }
});

/* =============================
   HEALTH CHECK ROUTE
============================= */
app.get("/", (req, res) => {
  res.send("ðŸš€ ProofChain Backend Running");
});

/* =============================
   SERVER START
============================= */
const PORT = process.env.PORT || 5000;

app.listen(PORT, () => {
  console.log(`ðŸš€ Backend running on port ${PORT}`);
});
