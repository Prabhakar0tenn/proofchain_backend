require("dotenv").config();

const express = require("express");
const cors = require("cors");
const algosdk = require("algosdk");
const mongoose = require("mongoose");
const generateHash = require("./utils/hash");
const Certificate = require("./models/Certificate");

console.log("ðŸš€ Server starting...");

const app = express();
app.use(cors());
app.use(express.json());

// ----------------------------
// ENV CHECK
// ----------------------------
if (!process.env.MNEMONIC || !process.env.MONGO_URI) {
  console.log("âŒ Missing environment variables");
  process.exit(1);
}

console.log("âœ… ENV Loaded");

// ----------------------------
// MongoDB Connection
// ----------------------------
mongoose.connect(process.env.MONGO_URI)
  .then(() => console.log("âœ… MongoDB Connected"))
  .catch(err => {
    console.log("âŒ MongoDB Error:", err.message);
    process.exit(1);
  });

// ----------------------------
// ALGOD CLIENT
// ----------------------------
const algodClient = new algosdk.Algodv2(
  "",
  "https://testnet-api.algonode.cloud",
  ""
);

// ----------------------------
// CREATOR ACCOUNT
// ----------------------------
let creatorAccount;

try {
  creatorAccount = algosdk.mnemonicToSecretKey(process.env.MNEMONIC);
  console.log("âœ… Creator Address:", creatorAccount.addr.toString());
} catch (err) {
  console.log("âŒ Failed to decode mnemonic");
  process.exit(1);
}

// ----------------------------
// MINT ROUTE
// ----------------------------
app.post("/mint", async (req, res) => {
  try {
    const { studentName, course } = req.body;

    if (!studentName || !course) {
      return res.status(400).json({
        success: false,
        message: "Student name and course required"
      });
    }

    console.log("ðŸ”¥ Mint request received");

    const certificateHash = generateHash(studentName, course);

    const params = await algodClient.getTransactionParams().do();

    const txn = algosdk.makeAssetCreateTxnWithSuggestedParamsFromObject({
      sender: creatorAccount.addr,
      total: 1,
      decimals: 0,
      assetName: "ProofChain Certificate",
      unitName: "CERT",
      assetURL: `https://proofchain.app/cert/${certificateHash}`,
      suggestedParams: params,
    });

    const signedTxn = txn.signTxn(creatorAccount.sk);

    const sendTx = await algodClient
      .sendRawTransaction(signedTxn)
      .do();

    const txId = sendTx.txId || sendTx.txid;

    if (!txId) {
      throw new Error("Transaction broadcast failed");
    }

    console.log("âœ… TX SENT:", txId);

    await Certificate.create({
      studentName,
      course,
      certificateHash,
      txId
    });

    res.json({
      success: true,
      txId,
      certificateHash
    });

  } catch (err) {
    console.log("âŒ ERROR:", err.message);
    res.status(500).json({
      success: false,
      error: err.message
    });
  }
});

// ----------------------------
// VERIFY ROUTE
// ----------------------------
app.get("/verify/:hash", async (req, res) => {
  try {
    const cert = await Certificate.findOne({
      certificateHash: req.params.hash
    });

    if (!cert) {
      return res.status(404).json({
        success: false,
        message: "Certificate not found"
      });
    }

    res.json({
      success: true,
      certificate: cert
    });

  } catch (err) {
    res.status(500).json({
      success: false,
      error: err.message
    });
  }
});

// ----------------------------
// HEALTH CHECK
// ----------------------------
app.get("/", (req, res) => {
  res.send("ðŸš€ ProofChain Backend Running");
});

// ----------------------------
// START SERVER
// ----------------------------
const PORT = process.env.PORT || 5000;

app.listen(PORT, () => {
  console.log(`ðŸš€ Backend running on port ${PORT}`);
});
